
name: Auto-generate Blog Post

permissions:
  contents: write

on:
  schedule:
    - cron: "0 2 * * 1"
  workflow_dispatch:
    inputs:
      topic:
        description: "Custom topic for the article"
        required: false
        default: "trending AI topic"

jobs:
  generate-blog:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: pip install openai jq

    - name: Create Python script
      run: |
        cat > generate_post.py << 'EOF'
        import os, openai, datetime, json

        api_key = os.environ.get("OPENAI_API_KEY")
        if not api_key:
            print("ERROR: No OpenAI API key found.")
            exit(1)

        openai.api_key = api_key
        today_date = datetime.date.today().strftime("%Y-%m-%d")
        today_display = datetime.date.today().strftime("%A, %B %d, %Y")
        topic = os.getenv("INPUT_TOPIC", "trending AI topic")

        print(f"Generating post for {today_display} (filename: {today_date})")

        meta_prompt = f"Generate a catchy blog title and a 2-sentence summary for {topic} as of {today_display}. Respond in JSON with keys: title, summary."
        try:
            resp = openai.chat.completions.create(
                model="gpt-4o-mini",
                messages=[{"role": "user", "content": meta_prompt}],
                max_tokens=200,
                response_format={"type": "json_object"}
            )
            raw = resp.choices[0].message.content.strip()
            meta = json.loads(raw)
            print(f"Generated meta: {meta}")
        except Exception as e:
            print("Meta generation failed:", e)
            meta = {"title": f"Weekly Blog Post - {today_display}", "summary": "Fallback summary."}

        title = meta.get("title")
        summary = meta.get("summary")

        article_prompt = f"Write a 600-word blog article titled '{title}' for {today_display}. Use proper HTML formatting with <h2> tags for subheadings, <p> tags for paragraphs. Do not include <html>, <head>, or <body> tags - just the content."
        try:
            resp2 = openai.chat.completions.create(
                model="gpt-4o-mini",
                messages=[{"role": "user", "content": article_prompt}],
                max_tokens=1000,
            )
            article_text = resp2.choices[0].message.content
            print("Article generated successfully")
        except Exception as e:
            print("Article generation failed:", e)
            article_text = "<p>Fallback: No article generated.</p>"

        html = f"""<!DOCTYPE html>
        <html>
        <head>
            <title>{title}</title>
            <style>
                body {{ font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }}
                h1 {{ color: #333; }}
                h2 {{ color: #666; border-bottom: 1px solid #eee; padding-bottom: 10px; }}
                p {{ line-height: 1.6; }}
            </style>
        </head>
        <body>
        <h1>{title}</h1>
        <p><em>{summary}</em></p>
        <div>{article_text}</div>
        </body></html>"""

        os.makedirs("posts", exist_ok=True)
        filename = f"posts/post-{today_date}.html"
        with open(filename, "w") as f:
            f.write(html)
        print(f"Article saved as: {filename}")

        with open("post_meta.json", "w") as f:
            json.dump({"title": title, "summary": summary}, f)
        print("Metadata saved")
        EOF

    - name: Generate blog post and update posts.json
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        INPUT_TOPIC: ${{ github.event.inputs.topic }}
      run: |
        set -xe
        mkdir -p posts
        TODAY=$(date +'%Y-%m-%d')
        POST_FILE="posts/post-${TODAY}.html"

        python generate_post.py

        TITLE=$(jq -r .title post_meta.json)
        SUMMARY=$(jq -r .summary post_meta.json)

        echo "Generated title: $TITLE"
        echo "Generated summary: $SUMMARY"
        echo "Post file: $POST_FILE"

        if [ ! -f posts.json ]; then
          echo "[]" > posts.json
        fi

        # Create new entry safely
        cat > new_entry.json << EOF
        {
          "title": $(echo "$TITLE" | jq -R .),
          "file": "$POST_FILE",
          "date": "$TODAY",
          "summary": $(echo "$SUMMARY" | jq -R .)
        }
        EOF

        # Update posts.json safely
        tmp=$(mktemp)
        jq "map(select(.date != \"$TODAY\")) + [$(cat new_entry.json)]" posts.json > "$tmp" && mv "$tmp" posts.json

        echo "Updated posts.json:"
        cat posts.json

        echo "Files in posts directory:"
        ls -la posts/

    - name: Commit and push changes
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        
        echo "Files before commit:"
        ls -la posts/
        
        git add .
        git status
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Auto blog post $(date +'%Y-%m-%d')"
          git push origin main
          echo "Changes committed and pushed"
        fi
