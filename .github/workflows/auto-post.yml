- name: Generate article with OpenAI
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        mkdir -p posts
        TODAY=$(date +'%Y-%m-%d')
        POST_FILE="posts/article-${TODAY}.html"

        python - <<'PYCODE'
import os, openai, datetime, json
openai.api_key = os.environ["OPENAI_API_KEY"]

today = datetime.date.today().strftime("%A, %B %d, %Y")

meta_prompt = f"Generate a catchy blog title and a 2-sentence summary for a trending AI topic as of {today}. Respond in JSON with keys: title, summary."
meta_resp = openai.chat.completions.create(
    model="gpt-4o-mini",
    messages=[{"role": "user", "content": meta_prompt}],
    max_tokens=150,
)

meta = json.loads(meta_resp.choices[0].message.content.strip())
title = meta.get("title", f"Weekly Blog Post - {today}")
summary = meta.get("summary", "Auto-generated article about AI.")

article_prompt = f"Write a 600-word blog article titled '{title}' for {today}. Include useful insights and structure it with H2 subheadings."
article_resp = openai.chat.completions.create(
    model="gpt-4o-mini",
    messages=[{"role": "user", "content": article_prompt}],
    max_tokens=1000,
)
article_text = article_resp.choices[0].message.content

html = f"""<!DOCTYPE html>
<html>
<head><title>{title}</title></head>
<body>
<h1>{title}</h1>
<p><em>{summary}</em></p>
<div>{article_text}</div>
</body></html>"""

# Write article
with open(f"posts/article-{today}.html", "w") as f:
    f.write(html)

# Prepare meta.json
with open("post_meta.json", "w") as f:
    json.dump({"title": title, "summary": summary}, f)
PYCODE

        TITLE=$(jq -r .title post_meta.json)
        SUMMARY=$(jq -r .summary post_meta.json)

        # Ensure posts.json always exists
        if [ ! -f posts.json ]; then
          echo "[]" > posts.json
        fi

        # Append new post
        jq ". + [{\"title\": \"$TITLE\", \"file\": \"posts/article-${TODAY}.html\", \"date\": \"${TODAY}\", \"summary\": \"$SUMMARY\"}]" posts.json > posts_tmp.json
        mv posts_tmp.json posts.json